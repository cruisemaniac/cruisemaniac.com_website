<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image:src content="https://cruisemaniac.com/images/1__uq2o1kma6dbi3_nnobvoa.png"><meta name=twitter:title content="Dockerizing your rails app - Only the gotchas!"><meta name=twitter:description content="Getting on the Docker bandwagon is no longer an option - Its the way to go. How do you do it right for your Ruby on Rails app"><meta name=twitter:site content="@cruisemaniac"><meta name=twitter:creator content="@Ashwin M"><meta name=author content="Ashwin M"><meta name=description content="DevOps, Infra and Cloud Expert"><meta name=generator content="Hugo 0.76.3"><title>Dockerizing your rails app - Only the gotchas! &#183; cruisemaniac.com</title><link href=https://fonts.googleapis.com rel=preconnect crossorigin=crossorigin><link href=https://fonts.gstatic.com rel=preconnect crossorigin=crossorigin><link href=https://www.google-analytics.com rel=preconnect crossorigin=crossorigin><link href=https://maxcdn.bootstrapcdn.com rel=preconnect crossorigin=crossorigin><link href=https://fonts.gstatic.com/s/notosans/v8/o-0IIpQlx3QUlC5A4PNr5TRASf6M7Q.woff2 rel=preload as=font crossorigin=crossorigin><link href=https://fonts.gstatic.com/s/dancingscript/v10/If2RXTr6YS-zF4S-kcSWSVi_szLgiuEHiC4W.woff2 rel=preload as=font crossorigin=crossorigin><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/fonts/fontawesome-webfont.woff2?v=4.7.0" rel=preload as=font crossorigin=crossorigin><link rel=stylesheet href=https://cruisemaniac.com/css/style.css><link rel=preload href=https://cruisemaniac.com/css/highlight.css as=style onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel=stylesheet href=https://cruisemaniac.com/css/highlight.css></noscript><link rel=preload href=https://cruisemaniac.com/css/font-awesome.min.css as=style onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel=stylesheet href=https://cruisemaniac.com/css/font-awesome.min.css></noscript><link href=https://cruisemaniac.com/index.xml rel=alternate type=application/rss+xml title=cruisemaniac.com><link rel=preload href=https://cruisemaniac.com/css/custom.css as=style onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel=stylesheet href=https://cruisemaniac.com/css/custom.css></noscript><link rel="shortcut icon" href=https://cruisemaniac.com/images/favicon.png></head><body><div id=page-container><section id=page-wrap><nav class=main-nav><a href=https://cruisemaniac.com/><span class=arrow>←</span>Home</a>
<a href=https://cruisemaniac.com/about>About</a>
<a href=https://cruisemaniac.com/tags>Tags</a>
<a href=https://cruisemaniac.com/projects-and-talks>Projects & Talks</a>
<a href=https://cruisemaniac.com/posts>Posts</a>
<a class=cta href=https://cruisemaniac.com/index.xml>RSS</a></nav><section id=wrapper class=post><article><header><h1>Dockerizing your rails app - Only the gotchas!</h1><h2 class=headline>Jun 28, 2020 17:30
· 825 words
· 4 minute read
<span class=tags>|
<a href=https://cruisemaniac.com/tags/rails>rails</a> |
<a href=https://cruisemaniac.com/tags/docker>docker</a> |
<a href=https://cruisemaniac.com/tags/containerisation>containerisation</a> |
<a href=https://cruisemaniac.com/tags/cloud>cloud</a> |</span></h2></header><section id=post-body><p>Containerisation is all the rage these days with every cloud provider offering some way or the other to deploy and manage containers. Running your Ruby on Rails application on a containerised platform will let you not only save, it also lets you get your changes faster to your end users. Are you doing it right or missing the obvious???</p><p>I have been meaning to run a few blog posts regarding containerising your apps and this is the first of them.</p><p>I&rsquo;ve worked with Rails apps for a good part of my career and am proud to say we&rsquo;ve put quite a few of them into containers and pushed them onto the cloud. Here goes -</p><h3 id=start-with-your-dockerfile>Start with your Dockerfile</h3><p>In a majority of cases, your app isnt starting from the ground up. You&rsquo;re re-modelling the deployment - taking it from a traditional compute virtualised architecture to a container based one.</p><p>This means one major thing - You need to get your Dev and Ops folks together and get started on the <code>Dockerfile</code>.</p><blockquote><p>Help your Devs with the <code>Dockerfile</code>! Ops know&rsquo;s how to optimise it, but more often than not, Devs know what goes where!</p></blockquote><p>Here&rsquo;s a sample from a Dockerfile template that I often start off of:</p><pre><code>FROM ruby:2.5-alpine
LABEL maintainer=&quot;Ashwin Murali &lt;mail@cruisemaniac.com&gt;&quot;
RUN apk update &amp;&amp; apk add build-base nodejs
postgresql-dev
RUN mkdir /app
WORKDIR /app
COPY Gemfile Gemfile.lock ./
RUN bundle install
COPY . .
CMD puma -C config/puma.rb
</code></pre><p>Notice from the snippet above that I do not use Ubuntu / Debian as a base image. And there&rsquo;s a reason. Alpine is light enough for you to run Ruby on Rails and there&rsquo;s more often than not, nothing else required for your app ecosystem.</p><blockquote><p>Remember, Your container is a runtime. Do not treat it as an OS / Ecosystem.</p></blockquote><p>As an Ops person, you should make it a point to work with your dev teams to get this running and building properly.</p><h3 id=you-do-not-need-ubuntu1604>YOU DO NOT NEED UBUNTU:16.04</h3><p>Have I said that before? Well, let me say that again! YOU DO NOT NEED UBUNTU:16.04. There&rsquo;s a very rare case that you need specialised libraries that alpine linux does not provide!</p><p>An example is <a href=https://github.com/jemalloc/jemalloc title=jemalloc>jemalloc</a> - the malloc implementation that helps handle fragmentation and high concurrency. I&rsquo;ve been there!</p><p>Alpine doesnt support jemalloc as of this writing. So switch to something that does, but not a full OS - we used <a href="https://hub.docker.com/layers/debian/library/debian/buster-slim/images/sha256-7c459309b9a5ec1683ef3b137f39ce5888f5ad0384e488ad73c94e0243bc77d4?context=explore" title="Debian Buster Slim">Debian-slim</a>. There&rsquo;s always workarounds! Explore them!</p><h3 id=local-development>Local Development</h3><p><img src=/images/dev-it-works.jpg#center alt></p><p>Now that you have a base <code>Dockerfile</code> in place, it is important that you as an ops person enable local development using said Dockerfile. The tool you should spend time on - <code>docker-compose</code>.</p><p>Your devs should be enabled to run their full app stacks using <code>docker-compose up</code>. At this point, your developing on local machines, testing them inside docker, having them break - this recurrence should be a thing of the past.</p><h4 id=the-thing-about-data>The thing about data</h4><p>Its a usual demand that devs and test folks need data to work through the myriad of use cases in your app. As an org, you should make it a process to mock that data - whether locally stored data or coming in via 3rd party end points - And running a container that mocks data is an absolutely trivial task.</p><p>Invest in it. You&rsquo;ll thank me later!</p><h3 id=stage--uat--prod>Stage / UAT / Prod</h3><p>This is where most of the Oh! Crap! moments come in. And here&rsquo;s a non-definitive list to look out for:</p><h4 id=separation-of-concerns>Separation of concerns</h4><p>Ensure that each docker image runs one process. And runs it well. Don&rsquo;t go lets run rails, let&rsquo;s run sidekiq, let&rsquo;s run cron, let&rsquo;s run iron man on the container!</p><blockquote><p>Run one process and one process only per container.</p></blockquote><p>Use docker&rsquo;s <code>CMD</code> to override the command you&rsquo;ll execute on the same codebase.</p><h4 id=work-with-dns>Work with DNS</h4><p>Your entire docker environment - swarm, kubernetes, fargate, whatever - they&rsquo;re going to run on ephemeral IPs. That is because Docker orchestration systems consider the container itself to be an ephemeral entity. It can run, it can be killed, it can be restarted again to serve a customer&rsquo;s request.</p><p>This guarantees one thing - you never know where another service is - if you&rsquo;re looking with an IP. Learn to use DNS. Learn to use service discovery.</p><blockquote><p><code>http://servicename:3000</code> is any day better!</p></blockquote><h4 id=statelessness-is-the-game>Statelessness is the game</h4><p>I left this for the last!</p><blockquote><p>DO not write to your docker file system!</p></blockquote><p>Use your persistent stores to store final state data - your databases, your file blob stores (s3, cloud storage, etc).</p><p>Use a sidecar to pick up logs and move it out of the container. You want your logs to move at the pace of your container. You do not want to be left in the lurch if the container has to be stopped and your logs havent been picked up.</p><p>I hope the list above is of a bit of help when wading through the process.</p><p>Until next time!</p></section></article><div class=row><div class=col><div class="newsletter row justify-content-center"><div class="col-lg-8 content"><p>If you'd like me to keep you posted:</p><link href=//cdn-images.mailchimp.com/embedcode/classic-10_7.css rel=stylesheet type=text/css><style type=text/css>#mc_embed_signup{background:#fff;clear:left;font:14px Helvetica,Arial,sans-serif}</style><div id=mc_embed_signup><form action="https://cruisemaniac.us8.list-manage.com/subscribe/post?u=d89d3ff810090855c61f96d04&id=53364f8a35" method=post id=mc-embedded-subscribe-form name=mc-embedded-subscribe-form class=validate target=_blank novalidate><div id=mc_embed_signup_scroll><div class=indicates-required><span class=asterisk>*</span> indicates required</div><div class=mc-field-group><label for=mce-EMAIL>Email Address <span class=asterisk>*</span></label>
<input type=email name=EMAIL class="required email" id=mce-EMAIL></div><div class=mc-field-group><label for=mce-FNAME>Name</label>
<input type=text name=FNAME id=mce-FNAME></div><div id=mce-responses class=clear><div class=response id=mce-error-response style=display:none></div><div class=response id=mce-success-response style=display:none></div></div><div style=position:absolute;left:-5000px aria-hidden=true><input type=text name=b_d89d3ff810090855c61f96d04_53364f8a35 tabindex=-1></div><div class=clear><input type=submit value=Subscribe name=subscribe id=mc-embedded-subscribe class=button></div></div></form></div></div></div></div></div></section></section><footer id=footer><div id=social><a class=symbol href=https://github.com/cruisemaniac aria-label=github-square alt="view github-square profile"><i class="fa fa-github-square"></i></a><a class=symbol href=https://linkedin.com/in/ashwinmurali aria-label=linkedin-square alt="view linkedin-square profile"><i class="fa fa-linkedin-square"></i></a><a class=symbol href=https://twitter.com/cruisemaniac aria-label=twitter-square alt="view twitter-square profile"><i class="fa fa-twitter-square"></i></a></div><p class=small>© 2020. Bangalore <i class="fa fa-heart" aria-hidden=true></i>|
Ashwin M</p></footer></div><script src=https://code.jquery.com/jquery-3.4.0.min.js integrity="sha256-BJeo0qm959uMBGb65z40ejJYGSgR7REI4+CW1fNKwOg=" crossorigin=anonymous></script><script src=https://cruisemaniac.com/js/main.js></script><script data-goatcounter=https://cruisemaniac.goatcounter.com/count async src=//gc.zgo.at/count.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/highlight.min.js></script><script>hljs.initHighlightingOnLoad();</script></body></html>